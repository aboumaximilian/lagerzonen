<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagerzonen â€” BoschstraÃŸe 60a, 50171 Kerpen</title>

  <!-- Leaflet & Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Turf.js fÃ¼r Polygon-Teilung -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Path Transform (Verschieben / Drehen) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-path-transform@1.8.0/dist/L.Path.Transform.css" />
  <script src="https://unpkg.com/leaflet-path-transform@1.8.0/dist/L.Path.Transform.js"></script>

  <!-- PapaParse fÃ¼r CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0b0f14; --panel:#121821; --text:#f3f6fb; --muted:#9fb0c0; --accent:#7cc4ff; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 1000; background: var(--panel); border-bottom: 1px solid #1d2735; padding: .75rem 1rem; display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 1rem; font-weight: 600; margin: 0 .5rem 0 0; }
    .spacer { flex: 1; }
    .pill { background: #0f1622; border: 1px solid #1e2a3d; border-radius: 999px; padding: .4rem .75rem; color: var(--muted); }
    .row { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    input[type=email], input[type=text], select { background: #0f1622; border: 1px solid #223146; border-radius: .5rem; color: var(--text); padding: .5rem .6rem; }
    input[type=file]{ color: var(--muted); }
    button { background: #1e2a3d; color: var(--text); border: 1px solid #2b3b55; border-radius: .5rem; padding: .5rem .75rem; cursor: pointer; }
    button:hover { filter: brightness(1.1); }

    #map { height: calc(100vh - 200px); width: 100%; }
    .leaflet-container { background: #0a0e13; }
    .legend { position: fixed; right: .75rem; bottom: .75rem; background: var(--panel); border: 1px solid #1d2735; border-radius: .75rem; padding: .5rem .75rem; font-size: .85rem; color: var(--muted); }
    .legend .dot { display:inline-block; width: .8rem; height: .8rem; border-radius: 2px; margin-right: .4rem; vertical-align: middle; }
    .hint { color: var(--muted); font-size: .9rem; }

    /* Blaues Aufleuchten */
    @keyframes glowPulse {
      0% { filter: drop-shadow(0 0 0 var(--accent)); }
      50% { filter: drop-shadow(0 0 10px var(--accent)) drop-shadow(0 0 18px var(--accent)); }
      100% { filter: drop-shadow(0 0 0 var(--accent)); }
    }
    .zone-glow path, .zone-glow polygon, .zone-glow .leaflet-interactive { animation: glowPulse 1.2s ease-in-out 2; }

    /* Transform-Handles sichtbarer */
    .leaflet-transform-resizable .leaflet-transform-handle { width: 12px; height: 12px; border-radius: 3px; }
    .leaflet-transform-rotatable .leaflet-transform-rotate { width: 14px; height: 14px; border-radius: 50%; }

    /* Responsive Popup */
    .zone-popup .leaflet-popup-content { max-height: 60vh; overflow:auto; }
    .zone-popup { max-width: 90vw !important; }
    @media (min-width: 800px){ .zone-popup { max-width: 420px !important; } }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ Lagerzonen â€” BoschstraÃŸe 60a</h1>
    <span class="pill">Fixes GrundstÃ¼ck, kostenlose Tools</span>
    <div class="spacer"></div>

    <!-- CSV & Liste -->
    <div class="row">
      <button id="btn-items-overview">ðŸ“‹ Artikel-Liste</button>
      <input id="csv-input" type="file" accept=".csv,text/csv" style="display:none" />
      <button id="btn-upload-csv" title="Artikelstamm CSV hochladen">â¬† CSV Artikelstamm</button>
    </div>

    <div id="auth" class="row">
      <div id="signed-out" class="row">
        <input id="email" type="email" placeholder="E-Mail fÃ¼r Magic Link" />
        <button id="sign-in">Einloggen</button>
      </div>
      <div id="signed-in" class="row" style="display:none">
        <span class="hint">Angemeldet als <strong id="user-email">â€“</strong></span>
        <button id="sign-out">Logout</button>
      </div>
      <button id="refresh">ðŸ”„ Aktualisieren</button>

      <!-- Projektwahl + Suche -->
      <div class="row" style="gap:.4rem">
        <select id="project-filter" style="min-width:220px">
          <option value="">â€” Projekt wÃ¤hlen â€”</option>
        </select>
        <input id="project-search" type="text" placeholder="Projekt suchenâ€¦" style="min-width:180px" />
        <button id="project-clear" title="Filter zurÃ¼cksetzen">âœ–</button>
      </div>

      <label class="row" style="gap:.4rem;align-items:center">
        <input id="sketch-mode" type="checkbox" />
        <span class="hint">Skizzenmodus (gestrichelt)</span>
      </label>
    </div>
  </header>

  <div id="map"></div>

  <div class="legend">
    <div><span class="dot" style="background:#4caf50"></span> frei</div>
    <div><span class="dot" style="background:#ff9800"></span> reserviert</div>
    <div><span class="dot" style="background:#f44336"></span> belegt</div>
  </div>

  <!-- Modal: Artikel-Liste -->
  <div id="items-modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h3 style="margin:0">ðŸ“‹ Artikel-Ãœbersicht</h3>
        <button id="items-modal-close">SchlieÃŸen</button>
      </div>
      <div id="items-table-wrap">
        <div class="hint">Ladeâ€¦</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Supabase ===
    const SUPABASE_URL = 'https://ntnxynmkwfvaahdmkbbw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50bnh5bm1rd2Z2YWFoZG1rYmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNzU1MTQsImV4cCI6MjA3MTk1MTUxNH0.TwDeFNl8vZbJ3l4vH4Zlxw2Vh8xLx0VQLfqPFN7kLQ4';
    const REDIRECT_URL = 'https://aboumaximilian.github.io/lagerzonen';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Karte ===
    const KERPEN = [50.881785, 6.668967];
    const BOUNDS = L.latLngBounds([ KERPEN[0] - 0.0006, KERPEN[1] - 0.0008 ], [ KERPEN[0] + 0.0006, KERPEN[1] + 0.0008 ]);
    const map = L.map('map', {
      maxBounds: BOUNDS, maxBoundsViscosity: 1.0
    }).setView(KERPEN, 19);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap-Mitwirkende' }).addTo(map);
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri & contributors' });

    L.control.layers({ 'Karte (OSM)': osm, 'Satellit (Esri)': esriSat }, {}, { position: 'topleft' }).addTo(map);
    L.rectangle(BOUNDS, { color: '#7cc4ff', weight: 1, fillOpacity: 0.03 }).addTo(map);

    // Map-Resize-Fixes
    const invalidate = () => setTimeout(() => map.invalidateSize(), 150);
    setTimeout(invalidate, 200);
    window.addEventListener('resize', invalidate);
    map.on('baselayerchange', invalidate);
    map.whenReady(invalidate);
    document.addEventListener('visibilitychange', invalidate);

    const zones = L.featureGroup().addTo(map);
    const overlays = L.featureGroup().addTo(map);
    const zoneLayerById = new Map();
    const zoneOrigColorById = new Map();

    // === Zeichnen/Bearbeiten ===
    const drawControl = new L.Control.Draw({
      draw: { polyline:false, circle:false, circlemarker:false, marker:false,
        polygon:{ allowIntersection:false, showArea:true }, rectangle:{ showArea:true } },
      edit: { featureGroup: L.featureGroup([zones, overlays]), remove:true }
    });
    function setDrawingEnabled(on){ if (on) map.addControl(drawControl); else try{ map.removeControl(drawControl);}catch(e){} }

    // === Auth UI ===
    const elEmail = document.getElementById('email');
    const elSignIn = document.getElementById('sign-in');
    const elSignOut = document.getElementById('sign-out');
    const elSignedIn = document.getElementById('signed-in');
    const elSignedOut = document.getElementById('signed-out');
    const elUserEmail = document.getElementById('user-email');
    const elRefresh = document.getElementById('refresh');

    // Projekt UI
    const elProjectFilter = document.getElementById('project-filter');
    const elProjectSearch = document.getElementById('project-search');
    const elProjectClear = document.getElementById('project-clear');
    let allProjects = [];

    // Artikel UI
    const elBtnOverview = document.getElementById('btn-items-overview');
    const elItemsModal = document.getElementById('items-modal');
    const elItemsClose = document.getElementById('items-modal-close');
    const elItemsTableWrap = document.getElementById('items-table-wrap');
    const elBtnUploadCsv = document.getElementById('btn-upload-csv');
    const elCsvInput = document.getElementById('csv-input');

    let currentUser = null;
    function updateAuthUI(){
      const authed = !!currentUser;
      elSignedIn.style.display = authed ? '' : 'none';
      elSignedOut.style.display = authed ? 'none' : '';
      elUserEmail.textContent = currentUser?.email ?? 'â€“';
      setDrawingEnabled(authed);
    }

    elSignIn.addEventListener('click', async () => {
      const email = (elEmail.value || '').trim();
      if (!email) return alert('Bitte E-Mail eingeben');
      const res = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: REDIRECT_URL } });
      if (res.error) return alert('Login-Fehler: ' + res.error.message);
      alert('Magic Link gesendet!');
    });
    elSignOut.addEventListener('click', async () => { await supabase.auth.signOut(); });
    elRefresh.addEventListener('click', () => { loadZones(); loadProjects(); });

    supabase.auth.onAuthStateChange((_e, session) => { currentUser = session?.user ?? null; updateAuthUI(); });
    (async () => {
      const s = await supabase.auth.getSession();
      currentUser = s.data?.session?.user ?? null;
      updateAuthUI();
      await loadZones();
      await loadProjects();
      await cleanupOrphanProjects();
      await loadProjects();
    })();

    // === Helpers ===
    const statusColor = s => s==='frei' ? '#4caf50' : (s==='reserviert' ? '#ff9800' : '#f44336');
    const escapeHtml = str => String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    // === GRID-TOOLS (Rechteck) ===
    function splitBounds(bounds, rows, cols){
      const sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
      const latStep = (ne.lat - sw.lat) / rows, lngStep = (ne.lng - sw.lng) / cols;
      const cells = [];
      for (let r=0; r<rows; r++){
        for (let c=0; c<cols; c++){
          const lat1 = sw.lat + r*latStep, lat2 = sw.lat + (r+1)*latStep;
          const lng1 = sw.lng + c*lngStep, lng2 = sw.lng + (c+1)*lngStep;
          const cellBounds = L.latLngBounds([lat1, lng1], [lat2, lng2]);
          const gj = L.rectangle(cellBounds).toGeoJSON();
          cells.push({ bounds: cellBounds, geojson: gj, r: r+1, c: c+1 });
        }
      }
      return cells;
    }

    // === POLYGON-GRID-TOOLS (Polygon in Raster schneiden) ===
    function splitPolygonIntoGrid(leafletLayer, rows, cols){
      const polyFeature = leafletLayer.toGeoJSON();
      const bounds = leafletLayer.getBounds();
      const sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
      const latStep = (ne.lat - sw.lat) / rows, lngStep = (ne.lng - sw.lng) / cols;
      const cells = [];
      for (let r=0; r<rows; r++){
        for (let c=0; c<cols; c++){
          const lat1 = sw.lat + r*latStep, lat2 = sw.lat + (r+1)*latStep;
          const lng1 = sw.lng + c*lngStep, lng2 = sw.lng + (c+1)*lngStep;
          const cellPoly = turf.polygon([[
            [lng1, lat1],[lng2, lat1],[lng2, lat2],[lng1, lat2],[lng1, lat1]
          ]]);
          const clipped = turf.intersect(polyFeature, cellPoly);
          if (!clipped) continue;
          try { if (turf.area(clipped) < 1) continue; } catch(e){}
          cells.push({ r:r+1, c:c+1, geojson: clipped });
        }
      }
      return cells;
    }

    // Utility: alle Path-Shapes eines GeoJSON-Layers sammeln
    function getPathChildren(geojsonLayer){
      if (!geojsonLayer) return [];
      if (geojsonLayer.getLayers) return geojsonLayer.getLayers().filter(l => l instanceof L.Path);
      return (geojsonLayer instanceof L.Path) ? [geojsonLayer] : [];
    }

    // === Zonen/Skizzen laden ===
    async function loadZones(){
      zones.clearLayers(); zoneLayerById.clear(); zoneOrigColorById.clear();
      const r = await supabase.from('storage_zones').select('id,name,status,color,geom,created_at').order('created_at',{ascending:true}).limit(1000);
      if (r.error) { console.error(r.error); return alert('Fehler beim Laden: '+r.error.message); }
      (r.data||[]).forEach(row => {
        if (!row.geom) return;
        const color = row.color || statusColor(row.status);
        const gj = typeof row.geom==='string' ? JSON.parse(row.geom) : row.geom;
        const layer = L.geoJSON(gj,{style:{color,weight:2,fillOpacity:0.3}}).addTo(zones);
        layer.eachLayer(l => l._zoneId=row.id);
        zoneLayerById.set(row.id, layer);
        zoneOrigColorById.set(row.id, color);
        layer.bindPopup(zonePopupHtml(row), {
          className: 'zone-popup',
          maxWidth: (window.innerWidth < 800 ? Math.min(420, Math.floor(window.innerWidth*0.9)) : 420),
          autoPan: true, keepInView: true,
          autoPanPaddingTopLeft:  [20,  80],
          autoPanPaddingBottomRight: [20, 140]
        });
        layer.on('popupopen', () => document.dispatchEvent(new CustomEvent('popupopen-for-zone',{detail:{layer,row}})));
      });
      await loadOverlays();
    }

    async function loadOverlays(){
      overlays.clearLayers();
      const r = await supabase.from('storage_overlays').select('id,label,notes,color,geom,created_at').order('created_at',{ascending:true}).limit(1000);
      if (r.error) { console.warn('Overlays:',r.error.message); return; }
      (r.data||[]).forEach(row => {
        if (!row.geom) return;
        const gj = typeof row.geom==='string' ? JSON.parse(row.geom) : row.geom;
        const layer = L.geoJSON(gj,{style:{color:row.color||'#7cc4ff',weight:2,fillOpacity:0.0,dashArray:'6,6'}}).addTo(overlays);
        layer.bindPopup(`<div><strong>${escapeHtml(row.label||'Skizze')}</strong><div class="hint">${row.notes?escapeHtml(row.notes):''}</div></div>`, { className:'zone-popup', keepInView:true });
      });
    }

    function zonePopupHtml(row){
      const addBtn = currentUser ? `<button class="btn-add-project" data-zone="${row.id}">+ Projekt</button>` : '';
      const transformBtn = currentUser ? `<button class="btn-transform" data-zone="${row.id}" title="Zone verschieben / drehen">Drehen/Verschieben</button>` : '';
      return `
        <div>
          <strong>${escapeHtml(row.name||'Zone')}</strong><br>
          <small class="hint">Status: ${escapeHtml(row.status||'â€”')}</small>
          <div class="hint">Erstellt: ${new Date(row.created_at).toLocaleString()}</div>
          <div class="row" style="margin:.4rem 0; gap:.4rem;">
            ${transformBtn}
          </div>
          <hr style="border-color:#1d2735">
          <div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
            <div class="hint">Projekte in dieser Zone</div>${addBtn}
          </div>
          <div id="projects-${row.id}" class="projects" style="margin:.5rem 0"></div>
          <div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
            <div class="hint">Artikel in dieser Zone</div>
            ${currentUser ? `<button class="btn-add-item" data-zone="${row.id}">+ Artikel</button>` : ''}
          </div>
          <div id="items-${row.id}" class="items" style="margin-top:.5rem"></div>
        </div>`;
    }

    // === Transform (verschieben/drehen) â€“ robust auf echten Path-Layern
    function enableTransformForZoneId(zoneId){
      const group = zoneLayerById.get(zoneId);
      if (!group) return 0;

      const paths = getPathChildren(group);
      if (!paths.length) return 0;

      // Popup schlieÃŸen, damit Handles nicht verdeckt werden
      try { group.closePopup?.(); } catch {}

      let enabled = 0;
      paths.forEach(path => {
        // bereits aktiv -> einmal deaktivieren (toggle)
        if (path.transform && path.transform._enabled) {
          path.transform.disable(); return;
        }
        // Plugin stellt .transform direkt bereit
        if (!path.transform) return; // Fallback: Plugin nicht geladen?
        path.transform.enable({ rotation:true, scaling:false, draggable:true });
        path.bringToFront?.();
        enabled++;

        const onEnd = async () => {
          path.off('transformend', onEnd);
          const gj = group.toGeoJSON();
          const r = await supabase.from('storage_zones').update({ geom: gj }).eq('id', zoneId);
          if (r.error) alert('Speichern der Transformation fehlgeschlagen: ' + r.error.message);
          else alert('Position/Ausrichtung gespeichert.');
        };
        path.on('transformend', onEnd);
      });
      return enabled;
    }

    // === Zeichnen â†’ Speichern (inkl. Grid-Aufteilung) ===
    map.on(L.Draw.Event.CREATED, async e => {
      if (!currentUser) return alert('Bitte vorher einloggen.');
      const layer = e.layer, layerType = e.layerType;
      const inside = BOUNDS.contains(layer.getBounds ? layer.getBounds() : layer.getLatLng());
      if (!inside) return alert('Form liegt auÃŸerhalb des GrundstÃ¼cks.');
      const sketch = document.getElementById('sketch-mode').checked;

      if (sketch){
        const label = prompt('Bezeichnung der Skizze (z.B. Baustellenzufahrt):') || 'Skizze';
        const notes = prompt('Notizen (optional):') || null;
        const gj = layer.toGeoJSON();
        if (layer.setStyle) layer.setStyle({ color:'#7cc4ff', weight:2, fillOpacity:0.0, dashArray:'6,6' });
        overlays.addLayer(layer);
        const r = await supabase.from('storage_overlays').insert({ label, notes, color:'#7cc4ff', geom:gj }).select('id').single();
        if (r.error){ overlays.removeLayer(layer); return alert('Skizze speichern fehlgeschlagen: ' + r.error.message); }
        layer.bindPopup(`<div><strong>${escapeHtml(label)}</strong>${notes?`<div class="hint">${escapeHtml(notes)}</div>`:''}</div>`, { className:'zone-popup', keepInView:true });
        return;
      }

      const name = prompt('Name der Zone (Basis, z.B. A):'); if (name===null) return;
      const status = prompt('Status (frei/reserviert/belegt):','frei') || 'frei';
      const color = statusColor(status);

      let didGrid = false;
      if (layerType === 'rectangle' || layerType === 'polygon'){
        const grid = prompt('Aufteilen? z.B. 3x2 (Spalten x Zeilen) â€” leer = keine Aufteilung:','');
        let cols=0, rows=0;
        if (grid && grid.trim()){
          const m = grid.trim().toLowerCase().match(/^([0-9]+)\s*[xÃ—]\s*([0-9]+)$/);
          if (m){ cols=parseInt(m[1],10); rows=parseInt(m[2],10); }
          else { const n=parseInt(grid,10); if(!isNaN(n)&&n>1){ cols=n; rows=1; } }
        }
        if (cols>0 && rows>0){
          const cells = layerType === 'rectangle'
            ? splitBounds(layer.getBounds(), rows, cols)
            : splitPolygonIntoGrid(layer, rows, cols);

          if (cells.length){
            const payload = cells.map(cell => ({ name: `${name}-${cell.c}/${cell.r}`, status, color, geom: cell.geojson }));
            const ins = await supabase.from('storage_zones').insert(payload).select('id,name,geom,created_at');
            if (ins.error) return alert('Speichern (Grid) fehlgeschlagen: '+ins.error.message);
            (ins.data||[]).forEach(row => {
              const gj = typeof row.geom==='string' ? JSON.parse(row.geom) : row.geom;
              const l = L.geoJSON(gj, { style:{ color, weight:2, fillOpacity:0.3 } }).addTo(zones);
              l.eachLayer(x => x._zoneId=row.id);
              zoneLayerById.set(row.id, l);
              zoneOrigColorById.set(row.id, color);
              l.bindPopup(zonePopupHtml({ id:row.id, name:row.name, status, color, created_at:row.created_at }), { className:'zone-popup', keepInView:true });
              l.on('popupopen', () => document.dispatchEvent(new CustomEvent('popupopen-for-zone',{detail:{layer:l,row:{ id:row.id, name:row.name, status, color, created_at:row.created_at }}})));
            });
            await loadProjects();
            didGrid = true;
          } else {
            alert('Keine Rasterzellen im Polygon â€“ eventuell zu klein?');
          }
        }
      }
      if (didGrid) return;

      // Einzel-Zone
      const gj2 = layer.toGeoJSON();
      zones.addLayer(layer);
      const r2 = await supabase.from('storage_zones').insert({ name, status, color, geom:gj2 }).select('id,created_at').single();
      if (r2.error){ zones.removeLayer(layer); return alert('Speichern fehlgeschlagen: '+r2.error.message); }
      layer._zoneId = r2.data.id;
      if (layer.setStyle) layer.setStyle({ color, fillOpacity:0.3, weight:2 });
      layer.bindPopup(zonePopupHtml({ id:r2.data.id, name, status, color, created_at:r2.data.created_at }), { className:'zone-popup', keepInView:true });
      layer.on('popupopen', () => document.dispatchEvent(new CustomEvent('popupopen-for-zone',{detail:{layer,row:{ id:r2.data.id, name, status, color, created_at:r2.data.created_at }}})));
      zoneLayerById.set(r2.data.id, layer);
      zoneOrigColorById.set(r2.data.id, color);
      await loadProjects();
    });

    // Bearbeiten (Leaflet.draw)
    map.on(L.Draw.Event.EDITED, async e => {
      const updates = [];
      e.layers.eachLayer(l => { if (l._zoneId) updates.push({ id:l._zoneId, geom:l.toGeoJSON() }); });
      for (const u of updates){
        const r = await supabase.from('storage_zones').update({ geom:u.geom }).eq('id', u.id);
        if (r.error) return alert('Update fehlgeschlagen: ' + r.error.message);
      }
      alert('Zonen aktualisiert.');
    });

    // LÃ¶schen
    map.on(L.Draw.Event.DELETED, async e => {
      const ids = [];
      e.layers.eachLayer(l => { if (l._zoneId) ids.push(l._zoneId); });
      if (!ids.length) return;
      const r = await supabase.from('storage_zones').delete().in('id', ids);
      if (r.error) return alert('LÃ¶schen fehlgeschlagen: ' + r.error.message);
      alert('Zonen gelÃ¶scht.');
      ids.forEach(id => { zoneLayerById.delete(id); zoneOrigColorById.delete(id); });
      await cleanupOrphanProjects();
      await loadProjects();
    });

    // === Items (Artikel) ===
    document.addEventListener('popupopen-for-zone', async ev => {
      const { layer, row } = ev.detail;
      const el = layer.getPopup()?.getElement(); if (!el) return;

      el.querySelector('.btn-transform')?.addEventListener('click', async () => {
        if (!currentUser) return alert('Bitte einloggen.');
        const count = enableTransformForZoneId(row.id);
        if (!count) alert('Konnte Transform nicht aktivieren. PrÃ¼fe, ob das Transform-Plugin geladen ist.');
      });

      await populateItems(row.id, el.querySelector('#items-'+row.id));
      await populateZoneProjects(row.id, el.querySelector('#projects-'+row.id));

      el.querySelector('.btn-add-item')?.addEventListener('click', async () => {
        if (!currentUser) return alert('Bitte einloggen.');
        await addItem(row.id);
        await populateItems(row.id, el.querySelector('#items-'+row.id));
      });
      el.querySelector('.btn-add-project')?.addEventListener('click', async () => {
        if (!currentUser) return alert('Bitte einloggen.');
        await addProjectToZone(row.id);
        await populateZoneProjects(row.id, el.querySelector('#projects-'+row.id));
        await loadProjects();
      });
    });

    async function populateItems(zoneId, container){
      if (!container) return;
      container.innerHTML = '<span class="hint">Lade Artikelâ€¦</span>';
      const r = await supabase.from('storage_items').select('id,article_number,name,qty,unit,notes,created_at').eq('zone_id', zoneId).order('created_at',{ascending:true});
      if (r.error) return container.innerHTML = '<span class="hint">Fehler: '+escapeHtml(r.error.message)+'</span>';
      const data = r.data||[];
      if (!data.length) return container.innerHTML = '<span class="hint">Keine Artikel vorhanden.</span>';
      container.innerHTML = data.map(it => {
        const qty = (it.qty ?? '')!=='' ? `&times; ${Number(it.qty)} ${it.unit?escapeHtml(it.unit):''}` : '';
        const notes = it.notes ? `<div class="hint">${escapeHtml(it.notes)}</div>` : '';
        const actions = currentUser ? `
          <div class="row">
            <button class="btn-edit-item" data-id="${it.id}">Bearbeiten</button>
            <button class="btn-del-item" data-id="${it.id}">LÃ¶schen</button>
          </div>` : '';
        const head = it.article_number ? `<span class="tag">${escapeHtml(it.article_number)}</span> ` : '';
        return `<div class="item-row" data-id="${it.id}" style="display:flex;gap:.5rem;justify-content:space-between;align-items:center;border:1px solid #1d2735;border-radius:.5rem;padding:.4rem .6rem;margin:.25rem 0;">
          <div>
            <div>${head}<strong>${escapeHtml(it.name)}</strong> ${qty}</div>
            ${notes}
          </div>
          ${actions}
        </div>`;
      }).join('');
      if (currentUser){
        container.querySelectorAll('.btn-edit-item').forEach(b => b.addEventListener('click', async () => {
          const id = b.getAttribute('data-id'); await editItem(id); await populateItems(zoneId, container);
        }));
        container.querySelectorAll('.btn-del-item').forEach(b => b.addEventListener('click', async () => {
          const id = b.getAttribute('data-id'); if (!confirm('Diesen Artikel lÃ¶schen?')) return;
          const r2 = await supabase.from('storage_items').delete().eq('id', id);
          if (r2.error) return alert('LÃ¶schen fehlgeschlagen: ' + r2.error.message);
          await populateItems(zoneId, container);
        }));
      }
    }

    // Artikelstamm (Cache fÃ¼r Auto-Fill)
    let itemCatalogByNumber = new Map();
    async function loadItemCatalog(){
      const r = await supabase.from('item_catalog').select('article_number,name,manufacturer').order('name');
      if (r.error){ console.warn('Katalog laden:', r.error); itemCatalogByNumber = new Map(); return; }
      itemCatalogByNumber = new Map((r.data||[]).filter(x=>x.article_number).map(x => [String(x.article_number).trim(), x]));
    }

    async function addItem(zoneId){
      await loadItemCatalog();
      let article_number = prompt('Artikelnummer (optional):','') || '';
      article_number = article_number.trim();

      let name = '';
      const cat = article_number ? itemCatalogByNumber.get(article_number) : null;
      if (cat){ name = cat.name || ''; }

      name = prompt('Artikel/Bezeichnung:', name || '') || name;
      const qtyStr = prompt('Menge (Zahl):','1'); const qty = qtyStr ? Number(qtyStr) : null;
      const unit = prompt('Einheit (z. B. Stk, Paletten, mÂ²):','Stk') || null;
      const notes = prompt('Notizen (optional):') || null;

      const r = await supabase.from('storage_items').insert({ zone_id: zoneId, article_number: article_number || null, name, qty, unit, notes });
      if (r.error) alert('Speichern fehlgeschlagen: ' + r.error.message);
    }

    async function editItem(itemId){
      await loadItemCatalog();
      const r = await supabase.from('storage_items').select('*').eq('id', itemId).single();
      if (r.error) return alert('Laden fehlgeschlagen: ' + r.error.message);
      const d = r.data;
      let article_number = prompt('Artikelnummer:', d.article_number || '') ?? d.article_number;
      article_number = (article_number||'').trim();
      let nameDefault = d.name || '';
      const cat = article_number ? itemCatalogByNumber.get(article_number) : null;
      if (cat && !nameDefault) nameDefault = cat.name || '';

      let name = prompt('Artikel/Bezeichnung:', nameDefault) ?? nameDefault;
      let qtyStr = prompt('Menge (Zahl):', d.qty ?? ''); if (qtyStr===null) qtyStr = String(d.qty ?? '');
      const qty = qtyStr!=='' ? Number(qtyStr) : null;
      let unit = prompt('Einheit:', d.unit || '') ?? d.unit;
      let notes = prompt('Notizen:', d.notes || '') ?? d.notes;

      const u = await supabase.from('storage_items').update({ article_number: article_number || null, name, qty, unit, notes }).eq('id', itemId);
      if (u.error) alert('Update fehlgeschlagen: ' + u.error.message);
    }

    // === Projekte ===
    async function loadProjects(){
      const sel = elProjectFilter; if (!sel) return;
      const r = await supabase.from('projects').select('id,name').order('name');
      if (r.error){ console.warn('Projekt-Ladefehler', r.error); return; }
      allProjects = (r.data||[]).map(p => ({id:p.id, name:p.name}));
      rebuildProjectOptions();
    }

    function rebuildProjectOptions(){
      const sel = elProjectFilter;
      const q = (elProjectSearch.value || '').toLowerCase().trim();
      const filtered = !q ? allProjects : allProjects.filter(p => p.name.toLowerCase().includes(q));
      const current = sel.value;
      sel.innerHTML = '<option value="">â€” Projekt wÃ¤hlen â€”</option>' + filtered.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
      if (!filtered.some(p => String(p.id)===String(current))) sel.value = '';
      else sel.value = current;
    }

    elProjectSearch.addEventListener('input', rebuildProjectOptions);
    elProjectClear.addEventListener('click', () => {
      elProjectSearch.value = '';
      elProjectFilter.value = '';
      highlightNone();
      rebuildProjectOptions();
    });

    elProjectFilter.addEventListener('change', async e => {
      const projectId = e.target.value;
      await highlightProject(projectId);
    });

    async function populateZoneProjects(zoneId, container){
      if (!container) return;
      container.innerHTML = '<span class="hint">Lade Projekteâ€¦</span>';
      const r = await supabase.from('zone_projects').select('id, project:projects(id,name)').eq('zone_id', zoneId).order('created_at',{ascending:true});
      if (r.error) return container.innerHTML = '<span class="hint">Fehler: '+escapeHtml(r.error.message)+'</span>';
      const data = r.data||[];
      if (!data.length) return container.innerHTML = '<span class="hint">Keine Projekte zugeordnet.</span>';
      container.innerHTML = data.map(zp => {
        const removeBtn = currentUser ? `<button class="btn-remove-project" data-id="${zp.id}">Entfernen</button>` : '';
        return `<div style="display:flex;justify-content:space-between;align-items:center;border:1px solid #1d2735;border-radius:.5rem;padding:.3rem .5rem;margin:.25rem 0;">
          <div><strong>${escapeHtml(zp.project?.name ?? 'Projekt')}</strong></div>${removeBtn}
        </div>`;
      }).join('');
      if (currentUser){
        container.querySelectorAll('.btn-remove-project').forEach(b => b.addEventListener('click', async () => {
          const id = b.getAttribute('data-id');
          const d = await supabase.from('zone_projects').delete().eq('id', id);
          if (d.error) return alert('Entfernen fehlgeschlagen: ' + d.error.message);
          await cleanupOrphanProjects();
          await populateZoneProjects(zoneId, container);
          await loadProjects();
        }));
      }
    }

    async function addProjectToZone(zoneId){
      const chk = await supabase.from('storage_zones').select('id').eq('id', zoneId).maybeSingle();
      if (chk.error) return alert('Zone prÃ¼fen fehlgeschlagen: ' + chk.error.message);
      if (!chk.data){ await loadZones(); return alert('Diese Zone existiert nicht mehr. Bitte aktualisieren.'); }
      let name = prompt('Projektname (neu oder bestehend):'); if (!name) return; name = name.trim();
      const existing = await supabase.from('projects').select('id').ilike('name', name).limit(1);
      if (existing.error) return alert('Suche fehlgeschlagen: ' + existing.error.message);
      let projectId = existing.data?.[0]?.id ?? null;
      if (!projectId){
        const created = await supabase.from('projects').insert({ name }).select('id').single();
        if (created.error) return alert('Projekt anlegen fehlgeschlagen: ' + created.error.message);
        projectId = created.data.id;
      }
      const link = await supabase.from('zone_projects').insert({ zone_id: zoneId, project_id: projectId });
      if (link.error) return alert('Zuordnung fehlgeschlagen: ' + link.error.message);
      alert('Projekt zugeordnet.');
      await loadProjects();
    }

    // === Hervorheben der Zonen eines Projekts ===
    async function highlightProject(projectId){
      zoneLayerById.forEach((layer, id) => {
        const orig = zoneOrigColorById.get(id) || '#7cc4ff';
        layer.setStyle?.({ color: orig, weight: 2, opacity: 1 });
        try { layer.getLayers?.().forEach(s => s._path?.classList?.remove('zone-glow')); } catch {}
      });
      if (!projectId) return;

      const r = await supabase.from('zone_projects').select('zone_id').eq('project_id', projectId);
      if (r.error){ alert('Projekt-Suche fehlgeschlagen: ' + r.error.message); return; }
      const ids = (r.data||[]).map(d => d.zone_id);
      if (!ids.length){ alert('FÃ¼r dieses Projekt sind keine Zonen hinterlegt.'); return; }

      let bounds = null;
      ids.forEach(id => {
        const l = zoneLayerById.get(id);
        if (!l) return;
        l.setStyle?.({ color: '#7cc4ff', weight: 4, opacity: 1, className: 'zone-glow' });
        try {
          l.getLayers?.().forEach(s => s._path?.classList?.add('zone-glow'));
          l.bringToFront?.();
          const b = l.getBounds?.();
          bounds = b ? (bounds ? bounds.extend(b) : b) : bounds;
        } catch {}
      });
      if (bounds) try{ map.fitBounds(bounds, { padding:[40,40] }); }catch{}
    }

    function highlightNone(){
      zoneLayerById.forEach((layer, id) => {
        const orig = zoneOrigColorById.get(id) || '#7cc4ff';
        layer.setStyle?.({ color: orig, weight: 2, opacity: 1 });
        try { layer.getLayers?.().forEach(s => s._path?.classList?.remove('zone-glow')); } catch {}
      });
    }

    // === Orphan-Projects entfernen ===
    async function cleanupOrphanProjects(){
      const proj = await supabase.from('projects').select('id');
      if (proj.error){ console.warn('Cleanup/Projects:', proj.error); return; }
      const links = await supabase.from('zone_projects').select('project_id');
      if (links.error){ console.warn('Cleanup/Links:', links.error); return; }
      const linked = new Set((links.data||[]).map(x => x.project_id));
      const orphans = (proj.data||[]).map(p => p.id).filter(id => !linked.has(id));
      if (orphans.length){
        const del = await supabase.from('projects').delete().in('id', orphans);
        if (del.error){ console.warn('Cleanup/Delete:', del.error); }
      }
    }

    // === CSV Upload (Artikelstamm) ===
    document.getElementById('btn-upload-csv').addEventListener('click', () => {
      if (!currentUser) return alert('Bitte einloggen.');
      document.getElementById('csv-input').value = '';
      document.getElementById('csv-input').click();
    });
    document.getElementById('csv-input').addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0]; if (!file) return;
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: async (results) => {
          try{
            const norm = s => (s||'').toString().trim();
            const rows = (results.data||[]).map(r => {
              const map = {}; for (const [k,v] of Object.entries(r)) map[k.toString().trim().toLowerCase()] = norm(v);
              const article_number = map['artikelnummer'] || map['artnr'] || map['artikel'] || '';
              const name = map['name'] || map['bezeichnung'] || '';
              const manufacturer = map['hersteller'] || map['lieferant'] || '';
              return { article_number: article_number||null, name: name||null, manufacturer: manufacturer||null };
            }).filter(x => x.article_number || x.name);
            if (!rows.length) return alert('Keine verwertbaren Zeilen gefunden.');
            const up = await supabase.from('item_catalog').upsert(rows, { onConflict: 'article_number' });
            if (up.error) return alert('CSV-Import fehlgeschlagen: ' + up.error.message);
            alert('Artikelstamm importiert/aktualisiert: ' + rows.length + ' Zeilen.');
          }catch(err){ alert('CSV-Parsing-Fehler: ' + err.message); }
        }
      });
    });

    // === Artikel-Liste (Modal) ===
    elBtnOverview.addEventListener('click', async () => {
      await showItemsOverview();
      elItemsModal.style.display = 'flex';
    });
    elItemsClose.addEventListener('click', () => { elItemsModal.style.display = 'none'; });

    async function showItemsOverview(){
      await loadItemCatalog();
      const r = await supabase.from('storage_items').select('article_number,name,qty,unit');
      if (r.error){ elItemsTableWrap.innerHTML = '<div class="hint">Fehler: '+escapeHtml(r.error.message)+'</div>'; return; }
      const list = r.data||[];
      const agg = new Map();
      for (const it of list){
        const key = (it.article_number || it.name || 'â€”').toString().trim().toLowerCase();
        const row = agg.get(key) || { article_number: it.article_number || null, name: it.name || null, manufacturer: null, qty: 0, units:new Set() };
        const q = typeof it.qty === 'number' ? it.qty : (it.qty ? Number(it.qty) : 0);
        if (!isNaN(q)) row.qty += q;
        if (it.unit) row.units.add(it.unit);
        if (row.article_number && itemCatalogByNumber.has(row.article_number)){
          const cat = itemCatalogByNumber.get(row.article_number);
          row.name = row.name || cat.name || row.name;
          row.manufacturer = cat.manufacturer || row.manufacturer;
        }
        agg.set(key, row);
      }
      const rows = Array.from(agg.values()).sort((a,b) => (a.name||'').localeCompare(b.name||''));
      elItemsTableWrap.innerHTML = `
        <table class="table">
          <thead>
          <tr><th style="width:140px">Artikelnummer</th><th>Name</th><th style="width:220px">Hersteller</th><th style="width:140px">Gesamtmenge</th><th style="width:120px">Einheit(en)</th></tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${r.article_number ? escapeHtml(r.article_number) : '<span class="hint">â€“</span>'}</td>
                <td>${r.name ? escapeHtml(r.name) : '<span class="hint">(ohne Name)</span>'}</td>
                <td>${r.manufacturer ? escapeHtml(r.manufacturer) : '<span class="hint">â€“</span>'}</td>
                <td>${Number(r.qty).toLocaleString()}</td>
                <td>${r.units.size ? escapeHtml(Array.from(r.units).join(', ')) : '<span class="hint">â€“</span>'}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }
  </script>
</body>
</html>
