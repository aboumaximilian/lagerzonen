<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagerzonen â€” BoschstraÃŸe 60a, 50171 Kerpen</title>
  <!-- Leaflet & Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --text:#f3f6fb; --muted:#9fb0c0; --accent:#7cc4ff; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 1000; background: var(--panel); border-bottom: 1px solid #1d2735; padding: .75rem 1rem; display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 1rem; font-weight: 600; margin: 0 .5rem 0 0; }
    .spacer { flex: 1; }
    .pill { background: #0f1622; border: 1px solid #1e2a3d; border-radius: 999px; padding: .4rem .75rem; color: var(--muted); }
    .row { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    input[type=email], input[type=text], select { background: #0f1622; border: 1px solid #223146; border-radius: .5rem; color: var(--text); padding: .5rem .6rem; }
    button { background: #1e2a3d; color: var(--text); border: 1px solid #2b3b55; border-radius: .5rem; padding: .5rem .75rem; cursor: pointer; }
    button:hover { filter: brightness(1.1); }

    #map { height: calc(100vh - 120px); width: 100%; }
    .leaflet-container { background: #0a0e13; }
    .legend { position: fixed; right: .75rem; bottom: .75rem; background: var(--panel); border: 1px solid #1d2735; border-radius: .75rem; padding: .5rem .75rem; font-size: .85rem; color: var(--muted); }
    .legend .dot { display:inline-block; width: .8rem; height: .8rem; border-radius: 2px; margin-right: .4rem; vertical-align: middle; }
    .hint { color: var(--muted); font-size: .9rem; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ Lagerzonen â€” BoschstraÃŸe 60a</h1>
    <span class="pill">Fixes GrundstÃ¼ck, kostenlose Tools</span>
    <div class="spacer"></div>
    <div id="auth" class="row">
      <div id="signed-out" class="row">
        <input id="email" type="email" placeholder="E-Mail fÃ¼r Magic Link" />
        <button id="sign-in">Einloggen</button>
      </div>
      <div id="signed-in" class="row" style="display:none">
        <span class="hint">Angemeldet als <strong id="user-email">â€“</strong></span>
        <button id="sign-out">Logout</button>
      </div>
      <button id="refresh">ðŸ”„ Aktualisieren</button>
      <select id="project-filter" style="min-width:220px">
        <option value="">â€” Projekt wÃ¤hlen â€”</option>
      </select>
      <label class="row" style="gap:.4rem;align-items:center">
        <input id="sketch-mode" type="checkbox" />
        <span class="hint">Skizzenmodus (gestrichelt)</span>
      </label>
    </div>
  </header>

  <div id="map"></div>

  <div class="legend">
    <div><span class="dot" style="background:#4caf50"></span> frei</div>
    <div><span class="dot" style="background:#ff9800"></span> reserviert</div>
    <div><span class="dot" style="background:#f44336"></span> belegt</div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Supabase ===
    const SUPABASE_URL = 'https://ntnxynmkwfvaahdmkbbw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50bnh5bm1rd2Z2YWFoZG1rYmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNzU1MTQsImV4cCI6MjA3MTk1MTUxNH0.TwDeFNl8vZbJ3l4vH4Zlxw2Vh8xLx0VQLfqPFN7kLQ4';
    const REDIRECT_URL = 'https://aboumaximilian.github.io/lagerzonen';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Karte ===
    const KERPEN = [50.881785, 6.668967];
    const BOUNDS = L.latLngBounds([
      KERPEN[0] - 0.0006, KERPEN[1] - 0.0008
    ], [
      KERPEN[0] + 0.0006, KERPEN[1] + 0.0008
    ]);

    const map = L.map('map', { maxBounds: BOUNDS, maxBoundsViscosity: 1.0 }).setView(KERPEN, 19);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 20,
      attribution: 'Tiles &copy; Esri & contributors'
    });

    L.control.layers({ 'Karte (OSM)': osm, 'Satellit (Esri)': esriSat }, {}, { position: 'topleft' }).addTo(map);
    L.rectangle(BOUNDS, { color: '#7cc4ff', weight: 1, fillOpacity: 0.03 }).addTo(map);
    setTimeout(function(){ map.invalidateSize(); }, 200);
    window.addEventListener('resize', function(){ map.invalidateSize(); });

    const zones = L.featureGroup().addTo(map);
    const overlays = L.featureGroup().addTo(map);
    const zoneLayerById = new Map();

    // === Zeichnen/Bearbeiten ===
    const drawControl = new L.Control.Draw({
      draw: { polyline:false, circle:false, circlemarker:false, marker:false,
        polygon:{ allowIntersection:false, showArea:true }, rectangle:{ showArea:true } },
      edit: { featureGroup: L.featureGroup([zones, overlays]), remove:true }
    });

    function setDrawingEnabled(enabled){
      if (enabled) { map.addControl(drawControl); }
      else { try { map.removeControl(drawControl); } catch(e){} }
    }

    // === Auth UI ===
    const elEmail = document.getElementById('email');
    const elSignIn = document.getElementById('sign-in');
    const elSignOut = document.getElementById('sign-out');
    const elSignedIn = document.getElementById('signed-in');
    const elSignedOut = document.getElementById('signed-out');
    const elUserEmail = document.getElementById('user-email');
    const elRefresh = document.getElementById('refresh');
    const elProjectFilter = document.getElementById('project-filter');

    var currentUser = null;
    function updateAuthUI(){
      var authed = !!currentUser;
      elSignedIn.style.display = authed ? '' : 'none';
      elSignedOut.style.display = authed ? 'none' : '';
      elUserEmail.textContent = currentUser && currentUser.email ? currentUser.email : 'â€“';
      setDrawingEnabled(authed);
    }

    elSignIn.addEventListener('click', async function(){
      var email = (elEmail.value || '').trim();
      if (!email) { alert('Bitte E-Mail eingeben'); return; }
      var res = await supabase.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: REDIRECT_URL }
      });
      if (res.error) { alert('Login-Fehler: ' + res.error.message); return; }
      alert('Magic Link gesendet!');
    });

    elSignOut.addEventListener('click', async function(){
      await supabase.auth.signOut();
    });
    elRefresh.addEventListener('click', loadZones);

    supabase.auth.onAuthStateChange(function(_e, session){
      currentUser = session && session.user ? session.user : null;
      updateAuthUI();
    });

    (async function init(){
      var s = await supabase.auth.getSession();
      currentUser = s.data && s.data.session ? s.data.session.user : null;
      updateAuthUI();
      await loadZones();
      await loadProjects();
    })();

    // === Helpers ===
    function statusColor(status){
      return status === 'frei' ? '#4caf50' : (status === 'reserviert' ? '#ff9800' : '#f44336');
    }
    function escapeHtml(str){
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // === Zonen laden ===
    async function loadZones(){
      zones.clearLayers(); zoneLayerById.clear();
      var r = await supabase.from('storage_zones').select('id,name,status,color,geom,created_by,created_at').order('created_at',{ascending:true}).limit(1000);
      if (r.error) { console.error(r.error); alert('Fehler beim Laden: '+r.error.message); return; }
      (r.data||[]).forEach(function(row){
        if (!row.geom) return;
        var gj = (typeof row.geom === 'string')?JSON.parse(row.geom):row.geom;
        var layer = L.geoJSON(gj,{style:{color:row.color||statusColor(row.status),weight:2,fillOpacity:0.3}}).addTo(zones);
        layer.eachLayer(function(l){ l._zoneId=row.id; });
        zoneLayerById.set(row.id,layer);
        layer.bindPopup(zonePopupHtml(row));
        layer.on('popupopen',function(){
          var ev=new CustomEvent('popupopen-for-zone',{detail:{layer:layer,row:row}});
          document.dispatchEvent(ev);
        });
      });
      await loadOverlays();
    }

    async function loadOverlays(){
      overlays.clearLayers();
      var r = await supabase.from('storage_overlays').select('id,label,notes,color,geom,created_by,created_at').order('created_at',{ascending:true}).limit(1000);
      if (r.error) { console.warn('Overlays laden:',r.error.message); return; }
      (r.data||[]).forEach(function(row){
        if (!row.geom) return;
        var gj=(typeof row.geom==='string')?JSON.parse(row.geom):row.geom;
        var layer=L.geoJSON(gj,{style:{color:row.color||'#7cc4ff',weight:2,fillOpacity:0.0,dashArray:'6,6'}}).addTo(overlays);
        layer.bindPopup('<div><strong>'+escapeHtml(row.label||'Skizze')+'</strong><div class="hint">'+(row.notes?escapeHtml(row.notes):'')+'</div></div>');
      });
    }

    function zonePopupHtml(row){
      var addBtn=currentUser?'<button class="btn-add-project" data-zone="'+row.id+'">+ Projekt</button>':'';
      return '<div>'+\
        '<strong>'+escapeHtml(row.name||'Zone')+'</strong><br>'+\
        '<small class="hint">Status: '+escapeHtml(row.status||'â€”')+'</small>'+\
        '<div class="hint">Erstellt: '+new Date(row.created_at).toLocaleString()+'</div>'+\
        '<hr style="border-color:#1d2735">'+\
        '<div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">'+\
          '<div class="hint">Projekte in dieser Zone</div>'+addBtn+\
        '</div>'+\
        '<div id="projects-'+row.id+'" class="projects" style="margin:.5rem 0"></div>'+\
        '<div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">'+\
          '<div class="hint">Artikel in dieser Zone</div>'+\
          (currentUser?'<button class="btn-add-item" data-zone="'+row.id+'">+ Artikel</button>':'')+\
        '</div>'+\
        '<div id="items-'+row.id+'" class="items" style="margin-top:.5rem"></div>'+\
      '</div>';
    }

    // === Zeichnen â†’ Speichern ===
    map.on(L.Draw.Event.CREATED,async function(e){
      if (!currentUser) { alert('Bitte vorher einloggen.'); return; }
      var layer=e.layer;
      var inside=BOUNDS.contains(layer.getBounds?layer.getBounds():layer.getLatLng());
      if (!inside) { alert('Form liegt auÃŸerhalb des GrundstÃ¼cks.'); return; }
      var sketch=document.getElementById('sketch-mode').checked;
      if (sketch){
        var label=prompt('Bezeichnung der Skizze (z.B. Baustellenzufahrt):')||'Skizze';
        var notes=prompt('Notizen (optional):')||null;
        var gj=layer.toGeoJSON();
        if (layer.setStyle) layer.setStyle({color:'#7cc4ff',weight:2,fillOpacity:0.0,dashArray:'6,6'});
        overlays.addLayer(layer);
        var r=await supabase.from('storage_overlays').insert({label:label,notes:notes,color:'#7cc4ff',geom:gj}).select('id').single();
        if (r.error){ alert('Skizze speichern fehlgeschlagen: '+r.error.message); overlays.removeLayer(layer); return; }
        layer.bindPopup('<div><strong>'+escapeHtml(label)+'</strong>'+(notes?('<div class="hint">'+escapeHtml(notes)+'</div>'):'')+'</div>');
      } else {
        var name=prompt('Name der Zone (z.B. A1):'); if (name===null) return;
        var status=prompt('Status (frei/reserviert/belegt):','frei')||'frei';
        var color=statusColor(status);
        var gj2=layer.toGeoJSON();
        zones.addLayer(layer);
        var r2=await supabase.from('storage_zones').insert({name:name,status:status,color:color,geom:gj2}).select('id,created_at').single();
        if (r2.error){ alert('Speichern fehlgeschlagen: '+r2.error.message); zones.removeLayer(layer); return; }
        layer._zoneId=r2.data.id;
        if (layer.setStyle) layer.setStyle({color:color,fillOpacity:0.3,weight:2});
        layer.bindPopup(zonePopupHtml({id:r2.data.id,name:name,status:status,color:
